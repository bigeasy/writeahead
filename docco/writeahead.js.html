<!DOCTYPE html>

<html>
<head>
  <title>writeahead.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="readme.t.js.html">
                  readme.t.js
                </a>


                <a class="source" href="writeahead.js.html">
                  writeahead.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>writeahead.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>)
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>).promises
<span class="hljs-keyword">const</span> fileSystem = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)
<span class="hljs-keyword">const</span> Keyify = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;keyify&#x27;</span>)
<span class="hljs-keyword">const</span> { Recorder, Player } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;transcript&#x27;</span>)
<span class="hljs-keyword">const</span> { Readable } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;stream&#x27;</span>)
<span class="hljs-keyword">const</span> Interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;interrupt&#x27;</span>)
<span class="hljs-keyword">const</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;assert&#x27;</span>)
<span class="hljs-keyword">const</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;extant&#x27;</span>)

<span class="hljs-keyword">let</span> latch

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WriteAhead</span> </span>{
    <span class="hljs-keyword">static</span> <span class="hljs-built_in">Error</span> = Interrupt.create(<span class="hljs-string">&#x27;WriteAhead.Error&#x27;</span>, {
        <span class="hljs-string">&#x27;IO_ERROR&#x27;</span>: {},
        <span class="hljs-string">&#x27;OPEN_ERROR&#x27;</span>: {
            <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;IO_ERROR&#x27;</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;unable to open file&#x27;</span>
        },
        <span class="hljs-string">&#x27;BLOCK_SHORT_READ&#x27;</span>: {
            <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;IO_ERROR&#x27;</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;incomplete read of block&#x27;</span>
        },
        <span class="hljs-string">&#x27;BLOCK_MISSING&#x27;</span>: {
            <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;IO_ERROR&#x27;</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;block did not parse correctly&#x27;</span>
        },
        <span class="hljs-string">&#x27;INVALID_CHECKSUM&#x27;</span>: {
            <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;IO_ERROR&#x27;</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;block contained an invalid checksum&#x27;</span>
        }
    })

    <span class="hljs-keyword">static</span> Stream = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Readable</span> </span>{
        <span class="hljs-title">constructor</span> (<span class="hljs-params">writeahead, key, poker = <span class="hljs-literal">null</span></span>) {
            <span class="hljs-built_in">super</span>()
            <span class="hljs-built_in">this</span>.writeahead = writeahead
            <span class="hljs-built_in">this</span>._poker = poker
            <span class="hljs-built_in">this</span>._index = <span class="hljs-number">0</span>
            <span class="hljs-built_in">this</span>._keyified = Keyify.stringify(key)
            <span class="hljs-built_in">this</span>.key = key
            <span class="hljs-built_in">this</span>._blocks = []
            <span class="hljs-built_in">this</span>._logs = <span class="hljs-built_in">this</span>.writeahead._logs.slice()
            <span class="hljs-built_in">this</span>._remainder = Buffer.alloc(<span class="hljs-number">0</span>)
            <span class="hljs-built_in">this</span>._player = <span class="hljs-keyword">new</span> Player(<span class="hljs-built_in">this</span>.writeahead._checksum)
            <span class="hljs-built_in">this</span>._log = <span class="hljs-literal">null</span>
            <span class="hljs-built_in">this</span>._filename = <span class="hljs-literal">null</span>
        }

        _calledback (error, ...vargs) {
            <span class="hljs-keyword">const</span> continued = vargs.pop()
            <span class="hljs-keyword">const</span> interrupt = WriteAhead.Error.poke(error != <span class="hljs-literal">null</span>, WriteAhead.prototype._calledback, <span class="hljs-built_in">this</span>._poker, <span class="hljs-literal">false</span>, vargs)
            <span class="hljs-keyword">if</span> (interrupt != <span class="hljs-literal">null</span>) {
                <span class="hljs-built_in">this</span>.destroy(interrupt)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">try</span> {
                    continued.apply(<span class="hljs-built_in">this</span>, vargs)
                } <span class="hljs-keyword">catch</span> (error) {
                    <span class="hljs-built_in">this</span>.destroy(error)
                }
            }
        }

        _read () {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._blocks.length == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._fd != <span class="hljs-literal">null</span>) {
                    fileSystem.close(<span class="hljs-built_in">this</span>._fd, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                        <span class="hljs-built_in">this</span>._calledback(error, <span class="hljs-string">&#x27;CLOSE_ERROR&#x27;</span>, [ error ], { <span class="hljs-attr">filename</span>: <span class="hljs-built_in">this</span>._filename }, <span class="hljs-function">() =&gt;</span> {
                            <span class="hljs-built_in">this</span>._fd = <span class="hljs-literal">null</span>
                            <span class="hljs-built_in">this</span>._read()
                        })
                    })
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._index == <span class="hljs-built_in">this</span>.writeahead._logs.length) {
                        <span class="hljs-built_in">this</span>.push(<span class="hljs-literal">null</span>)
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-built_in">this</span>._log = <span class="hljs-built_in">this</span>.writeahead._logs[<span class="hljs-built_in">this</span>._index++]
                        <span class="hljs-built_in">this</span>._blocks = <span class="hljs-built_in">this</span>.writeahead._blocks[<span class="hljs-built_in">this</span>._log.id][<span class="hljs-built_in">this</span>._keyified].slice()
                        <span class="hljs-built_in">this</span>._read()
                    }
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._fd == <span class="hljs-literal">null</span>) {
                <span class="hljs-built_in">this</span>._filename = path.join(<span class="hljs-built_in">this</span>.writeahead.directory, <span class="hljs-built_in">String</span>(<span class="hljs-built_in">this</span>._log.id))
                fileSystem.open(<span class="hljs-built_in">this</span>._filename, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">error, fd</span>) =&gt;</span> {
                    <span class="hljs-built_in">this</span>._calledback(error, <span class="hljs-string">&#x27;OPEN_ERROR&#x27;</span>, [ error ], { <span class="hljs-attr">filename</span>: <span class="hljs-built_in">this</span>._filename }, <span class="hljs-function">() =&gt;</span> {
                        <span class="hljs-built_in">this</span>._fd = fd
                        <span class="hljs-built_in">this</span>._read()
                    })
                })
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">const</span> block = <span class="hljs-built_in">this</span>._blocks.shift()
                <span class="hljs-keyword">const</span> buffer = Buffer.alloc(block.length)
                fileSystem.read(<span class="hljs-built_in">this</span>._fd, buffer, <span class="hljs-number">0</span>, buffer.length, block.position, <span class="hljs-function">(<span class="hljs-params">error, read</span>) =&gt;</span> {
                    <span class="hljs-built_in">this</span>._calledback(error, <span class="hljs-string">&#x27;READ_ERROR&#x27;</span>, [ error ], { <span class="hljs-attr">filename</span>: <span class="hljs-built_in">this</span>._filename }, <span class="hljs-function">() =&gt;</span> {
                        WriteAhead.Error.assert(read == buffer.length, <span class="hljs-string">&#x27;BLOCK_SHORT_READ&#x27;</span>)
                        <span class="hljs-keyword">const</span> entries = <span class="hljs-built_in">this</span>._player.split(buffer)
                        WriteAhead.Error.assert(entries.length == <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;BLOCK_MISSING&#x27;</span>)
                        <span class="hljs-built_in">this</span>.push(entries[<span class="hljs-number">0</span>].parts[<span class="hljs-number">1</span>])
                    })
                })
            }
        }

        _destroy (error, callback) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._fd != <span class="hljs-literal">null</span>) {
                fileSystem.close(<span class="hljs-built_in">this</span>._fd, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
                    <span class="hljs-built_in">this</span>._fd = <span class="hljs-literal">null</span>
                    <span class="hljs-built_in">this</span>._destroy(e || error, callback)
                })
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error) {
                callback(error)
            } <span class="hljs-keyword">else</span> {
                callback()
            }
        }
    }

    <span class="hljs-title">constructor</span> (<span class="hljs-params">{ directory, logs, checksum, blocks }</span>) {
        <span class="hljs-built_in">this</span>.directory = directory
        <span class="hljs-built_in">this</span>._logs = logs
        <span class="hljs-built_in">this</span>._recorder = Recorder.create(checksum)
        <span class="hljs-built_in">this</span>._blocks = blocks
        <span class="hljs-built_in">this</span>._checksum = checksum
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._logs.length == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">this</span>._blocks[<span class="hljs-number">0</span>] = []
            <span class="hljs-built_in">this</span>._logs.push({ <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">readers</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">shifted</span>: <span class="hljs-literal">false</span> })
        }
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> open ({ directory, checksum = <span class="hljs-function">() =&gt;</span> <span class="hljs-number">0</span> }, converter) {
        <span class="hljs-keyword">const</span> dir = <span class="hljs-keyword">await</span> fs.readdir(directory)
        <span class="hljs-keyword">const</span> ids = dir.filter(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-regexp">/^\d+$/</span>.test(file))
                       .map(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> +log)
                       .sort(<span class="hljs-function">(<span class="hljs-params">left, right</span>) =&gt;</span> left - right)
        <span class="hljs-keyword">const</span> player = <span class="hljs-keyword">new</span> Player(checksum)
        <span class="hljs-keyword">const</span> blocks = {}
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> ids) {
            blocks[id] = {}
            <span class="hljs-keyword">const</span> readable = fileSystem.createReadStream(path.join(directory, <span class="hljs-built_in">String</span>(id)))
            <span class="hljs-keyword">let</span> position = <span class="hljs-number">0</span>, remainder = <span class="hljs-number">0</span>
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> block <span class="hljs-keyword">of</span> readable) {
                <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>
                <span class="hljs-keyword">for</span> (;;) {
                    <span class="hljs-keyword">const</span> [ entry ] = player.split(block.slice(offset), <span class="hljs-number">1</span>)
                    <span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">break</span>
                    }
                    <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">String</span>(entry.parts[<span class="hljs-number">0</span>]))
                                     .map(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> Keyify.stringify(key))
                    <span class="hljs-keyword">const</span> length = entry.sizes.reduce(<span class="hljs-function">(<span class="hljs-params">sum, value</span>) =&gt;</span> sum + value, <span class="hljs-number">0</span>)
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
                        blocks[id][key] || (blocks[id][key] = [])
                        blocks[id][key].push({ position, length })
                    }
                    position += length
                    offset += length - remainder
                    remainder = <span class="hljs-number">0</span>
                }
                remainder = block.length - offset
            }
        }
        <span class="hljs-keyword">const</span> logs = ids.map(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> ({ id, <span class="hljs-attr">readers</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">shifted</span>: <span class="hljs-literal">false</span> }))
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WriteAhead({ directory, logs, checksum, blocks })
    }</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Write a batch of entries to the write-ahead log. <code>entries</code> is an array of
application specific objects to log. <code>converter</code> converts the entry to a
set of keys, header and body.</p>
<p>The keys are used to reconstruct a file stream from the write-ahead log.
The body of the message will be included in the stream constructed for
any of the keys in the set of keys. It is up to the application to fish
out the relevant content from the body for a given key.</p>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">async</span> write (entries, converter) {
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">_recorder</span>: recorder } = <span class="hljs-built_in">this</span>
        <span class="hljs-keyword">const</span> log = <span class="hljs-built_in">this</span>._logs[<span class="hljs-built_in">this</span>._logs.length - <span class="hljs-number">1</span>]
        <span class="hljs-keyword">const</span> filename = path.join(<span class="hljs-built_in">this</span>.directory, <span class="hljs-built_in">String</span>(log.id))
        <span class="hljs-keyword">const</span> handle = <span class="hljs-keyword">await</span> fs.open(filename, <span class="hljs-string">&#x27;a&#x27;</span>)
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> stat = <span class="hljs-keyword">await</span> handle.stat()
            <span class="hljs-keyword">let</span> position = stat.size
            <span class="hljs-keyword">const</span> buffers = [], positions = {}
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
                <span class="hljs-keyword">const</span> { keys, body } = converter(entry)
                <span class="hljs-keyword">const</span> keyified = keys.map(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> Keyify.stringify(key))
                <span class="hljs-keyword">const</span> block = recorder([[ Buffer.from(<span class="hljs-built_in">JSON</span>.stringify(keys)) ], [ body ]])
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keyified) {
                    positions[key] || (positions[key] = [])
                    positions[key].push({ position, <span class="hljs-attr">length</span>: block.length })
                }
                position += block.length
                buffers.push(block)
            }
            <span class="hljs-keyword">await</span> handle.appendFile(Buffer.concat(buffers))
            <span class="hljs-keyword">await</span> handle.sync()
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> positions) {
                <span class="hljs-built_in">this</span>._blocks[log.id][key] || (<span class="hljs-built_in">this</span>._blocks[log.id][key] = [])
                <span class="hljs-built_in">this</span>._blocks[log.id][key].push.apply(<span class="hljs-built_in">this</span>._blocks[log.id][key], positions[key])
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">await</span> handle.close()
        }
    }

    <span class="hljs-keyword">async</span> rotate () {
        <span class="hljs-keyword">const</span> log = { <span class="hljs-attr">id</span>: <span class="hljs-built_in">this</span>._logs[<span class="hljs-built_in">this</span>._logs.length - <span class="hljs-number">1</span>].id + <span class="hljs-number">1</span>, <span class="hljs-attr">readers</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">shifted</span>: <span class="hljs-literal">false</span> }
        <span class="hljs-keyword">const</span> filename = path.join(<span class="hljs-built_in">this</span>.directory, <span class="hljs-built_in">String</span>(log.id))
        <span class="hljs-keyword">await</span> fs.writeFile(filename, <span class="hljs-string">&#x27;&#x27;</span>, { <span class="hljs-attr">flags</span>: <span class="hljs-string">&#x27;wx&#x27;</span> })
        <span class="hljs-built_in">this</span>._logs.push(log)
        <span class="hljs-built_in">this</span>._blocks[log.id] = []
    }

    <span class="hljs-keyword">async</span> shift () {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._logs.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
        <span class="hljs-comment">/*
        if (this._logs[0].readers != 0) {
            this._logs[0].latch = {
                promise: new Promise(resolve =&gt; latch = { resolve }),
                ...latch
            }
            await this._logs[0].latch.promise
        }
        */</span>
        <span class="hljs-keyword">const</span> log = <span class="hljs-built_in">this</span>._logs.shift()
        <span class="hljs-keyword">const</span> filename = path.join(<span class="hljs-built_in">this</span>.directory, <span class="hljs-built_in">String</span>(log.id))
        <span class="hljs-keyword">await</span> fs.unlink(filename)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}

<span class="hljs-built_in">module</span>.exports = WriteAhead</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
